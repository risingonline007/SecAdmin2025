<Sysmon schemaversion="4.90">
  <!-- Ajusta los algoritmos de hash según tus necesidades -->
  <HashAlgorithms>sha256,IMPHASH</HashAlgorithms>
  <CheckRevocation>False</CheckRevocation>

  <EventFiltering>

    <!-- 1: Process Create -->
    <!-- Solo procesos potencialmente peligrosos o interesantes -->
    <ProcessCreate onmatch="include">
      <!-- LOLBins y herramientas de scripting -->
      <RuleGroup name="Scripting - LOLBins" groupRelation="or">
        <Image condition="end with">powershell.exe</Image>
        <Image condition="end with">pwsh.exe</Image>
        <Image condition="end with">cmd.exe</Image>
        <Image condition="end with">wscript.exe</Image>
        <Image condition="end with">cscript.exe</Image>
        <Image condition="end with">mshta.exe</Image>
        <Image condition="end with">rundll32.exe</Image>
        <Image condition="end with">regsvr32.exe</Image>
        <Image condition="end with">msbuild.exe</Image>
        <Image condition="end with">wmic.exe</Image>
        <Image condition="end with">schtasks.exe</Image>
      </RuleGroup>

      <!-- Herramientas de administración remota / lateral movement -->
      <RuleGroup name="Remote Admin - Lateral Movement" groupRelation="or">
        <Image condition="end with">psexec.exe</Image>
        <Image condition="end with">psexesvc.exe</Image>
        <Image condition="end with">mstsc.exe</Image>
        <Image condition="end with">winrm.vbs</Image>
      </RuleGroup>

      <!-- Procesos que arrancan desde ubicaciones sospechosas del usuario -->
      <RuleGroup name="User profile suspicious paths" groupRelation="or">
        <Image condition="contains">\AppData\Local\Temp\</Image>
        <Image condition="contains">\AppData\Roaming\</Image>
        <Image condition="contains">\Downloads\</Image>
        <Image condition="contains">\Users\Public\</Image>
      </RuleGroup>

      <!-- Procesos ofimáticos lanzando hijos (macro attacks) -->
      <RuleGroup name="Office spawning children" groupRelation="or">
        <ParentImage condition="end with">winword.exe</ParentImage>
        <ParentImage condition="end with">excel.exe</ParentImage>
        <ParentImage condition="end with">powerpnt.exe</ParentImage>
        <ParentImage condition="end with">outlook.exe</ParentImage>
      </RuleGroup>
    </ProcessCreate>

    <!-- 3: Network connection -->
    <!-- Conexiones iniciadas por procesos sospechosos -->
    <NetworkConnect onmatch="include">
      <RuleGroup name="Network from suspicious processes" groupRelation="or">
        <Image condition="end with">powershell.exe</Image>
        <Image condition="end with">pwsh.exe</Image>
        <Image condition="end with">cmd.exe</Image>
        <Image condition="end with">wscript.exe</Image>
        <Image condition="end with">cscript.exe</Image>
        <Image condition="end with">mshta.exe</Image>
        <Image condition="end with">rundll32.exe</Image>
        <Image condition="end with">regsvr32.exe</Image>
        <Image condition="end with">psexec.exe</Image>
        <Image condition="contains">\AppData\</Image>
        <Image condition="contains">\Users\Public\</Image>
      </RuleGroup>
    </NetworkConnect>

    <!-- 7: Image loaded -->
    <!-- Carga de DLLs desde rutas inusuales / usuario -->
    <ImageLoad onmatch="include">
      <RuleGroup name="DLL from user profile" groupRelation="or">
        <ImageLoaded condition="contains">\Users\</ImageLoaded>
        <ImageLoaded condition="contains">\AppData\</ImageLoaded>
        <ImageLoaded condition="contains">\Temp\</ImageLoaded>
      </RuleGroup>
    </ImageLoad>

    <!-- 8: CreateRemoteThread -->
    <!-- Muy útil para detectar inyecciones de código -->
    <CreateRemoteThread onmatch="include">
      <RuleGroup name="All CreateRemoteThread" groupRelation="or">
        <TargetImage condition="is not">C:\Windows\System32\svchost.exe</TargetImage>
      </RuleGroup>
    </CreateRemoteThread>

    <!-- 10: Process Access -->
    <!-- Solo accesos de herramientas sospechosas a otros procesos -->
    <ProcessAccess onmatch="include">
      <RuleGroup name="Suspicious tools accessing processes" groupRelation="or">
        <CallTrace condition="contains">\AppData\</CallTrace>
        <SourceImage condition="end with">powershell.exe</SourceImage>
        <SourceImage condition="end with">pwsh.exe</SourceImage>
        <SourceImage condition="end with">cmd.exe</SourceImage>
        <SourceImage condition="end with">psexec.exe</SourceImage>
        <SourceImage condition="end with">procdump.exe</SourceImage>
        <SourceImage condition="end with">lsass.exe</SourceImage>
      </RuleGroup>
    </ProcessAccess>

    <!-- 11: File Create -->
    <!-- Creación de ficheros ejecutables en rutas de usuario -->
    <FileCreate onmatch="include">
      <RuleGroup name="Executable in user paths" groupRelation="or">
        <TargetFilename condition="end with">.exe</TargetFilename>
        <TargetFilename condition="end with">.dll</TargetFilename>
        <TargetFilename condition="end with">.scr</TargetFilename>
        <TargetFilename condition="end with">.ps1</TargetFilename>
        <TargetFilename condition="end with">.vbs</TargetFilename>
        <TargetFilename condition="end with">.js</TargetFilename>
      </RuleGroup>
      <RuleGroup name="Suspicious locations" groupRelation="or">
        <TargetFilename condition="contains">\AppData\Local\Temp\</TargetFilename>
        <TargetFilename condition="contains">\AppData\Roaming\</TargetFilename>
        <TargetFilename condition="contains">\Users\Public\</TargetFilename>
        <TargetFilename condition="contains">\ProgramData\</TargetFilename>
      </RuleGroup>
    </FileCreate>

    <!-- 12,13,14: Registry (autoruns, seguridad) -->
    <RegistryEvent onmatch="include">
      <!-- 12: Registry Set, 13: Registry Key, 14: Registry Value -->
      <RuleGroup name="Autoruns modifications" groupRelation="or">
        <TargetObject condition="contains">\CurrentVersion\Run</TargetObject>
        <TargetObject condition="contains">\CurrentVersion\RunOnce</TargetObject>
        <TargetObject condition="contains">\CurrentVersion\Policies\System</TargetObject>
        <TargetObject condition="contains">\Services\</TargetObject>
      </RuleGroup>
    </RegistryEvent>

    <!-- 15: FileCreateStreamHash (ADS) -->
    <FileCreateStreamHash onmatch="include">
      <RuleGroup name="Alternate Data Streams" groupRelation="or">
        <TargetFilename condition="contains">:</TargetFilename>
      </RuleGroup>
    </FileCreateStreamHash>

    <!-- 22: DNS Query -->
    <!-- Solo consultas desde procesos sospechosos -->
    <DnsQuery onmatch="include">
      <RuleGroup name="DNS from suspicious processes" groupRelation="or">
        <Image condition="end with">powershell.exe</Image>
        <Image condition="end with">pwsh.exe</Image>
        <Image condition="end with">cmd.exe</Image>
        <Image condition="end with">wscript.exe</Image>
        <Image condition="end with">cscript.exe</Image>
        <Image condition="end with">mshta.exe</Image>
        <Image condition="contains">\AppData\</Image>
        <Image condition="contains">\Users\Public\</Image>
      </RuleGroup>
    </DnsQuery>

    <!-- 25: ProcessTampering (útil en escenarios modernos) -->
    <ProcessTampering onmatch="include">
      <RuleGroup name="All ProcessTampering" groupRelation="or">
        <SourceImage condition="is not">C:\Windows\System32\</SourceImage>
      </RuleGroup>
    </ProcessTampering>

  </EventFiltering>
</Sysmon>
